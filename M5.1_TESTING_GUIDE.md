# M5.1: In-App Messaging - Testing Guide

## Prerequisites

Before testing, ensure all dependencies are installed:

```bash
cd backend
pip install -r requirements.txt
```

**Note**: If you encounter issues installing `psycopg2-binary` or `twilio` on Windows, you can skip Twilio for now (it's only needed for M5.2 SMS features). The messaging system (M5.1) only requires:
- Flask-SocketIO==5.3.6
- python-socketio==5.11.0

## What Was Implemented

### Backend (✅ Complete)
1. **Database Models** (`backend/models/database.py`):
   - `MessageThread` - Conversation threads between trainers and clients
   - `Message` - Individual messages with read receipts
   - `MessageAttachment` - File attachments in messages

2. **API Routes** (`backend/api/message_routes.py`):
   - GET `/api/messages/threads` - List all conversations
   - POST `/api/messages/threads` - Create new conversation
   - GET `/api/messages/threads/:id` - Get thread with messages
   - POST `/api/messages/threads/:id/messages` - Send message
   - PUT `/api/messages/threads/:id/read` - Mark thread as read
   - PUT `/api/messages/messages/:id/read` - Mark message as read
   - DELETE `/api/messages/messages/:id` - Delete message
   - GET `/api/messages/search` - Search messages
   - GET `/api/messages/unread-count` - Get unread count
   - PUT `/api/messages/threads/:id/archive` - Archive thread

3. **WebSocket Support** (`backend/app.py`):
   - Flask-SocketIO integration for real-time messaging
   - Socket.IO event handlers for thread rooms
   - Real-time message broadcasting

### Frontend (✅ Complete)
1. **Messaging Interface** (`frontend/messages.html`):
   - Thread list sidebar
   - Chat interface
   - New thread modal
   - Search functionality

2. **JavaScript** (`frontend/src/messages.js`):
   - Socket.IO client integration
   - Real-time message updates
   - Thread management
   - Message sending/receiving

## Testing Steps

### 1. Start the Backend Server

```bash
cd backend
python app.py
```

The server should start on `http://localhost:5000` (or the PORT specified in your environment).

**Expected output:**
```
Starting Fitness CRM API on port 5000
Database tables created/verified
```

### 2. Start the Frontend (if using Vite)

```bash
cd frontend
npm run dev
```

Or if using a static server, ensure the frontend files are accessible.

### 3. Test the Messaging Interface

1. **Navigate to Messages Page**:
   - Open `http://localhost:3000/messages.html` (or your frontend URL)
   - You should see the messaging interface

2. **Create a New Thread**:
   - Click "New Message" button
   - Select a recipient (trainer or client)
   - Enter a subject (optional)
   - Type an initial message
   - Click "Send"
   - The thread should appear in the sidebar

3. **Send Messages**:
   - Click on a thread to open it
   - Type a message in the input box
   - Press Enter or click Send
   - Message should appear immediately

4. **Test Real-Time Updates**:
   - Open the same page in two browser windows/tabs
   - Log in as different users (trainer vs client)
   - Send a message from one window
   - It should appear in the other window in real-time

5. **Test Search**:
   - Use the search box in the threads panel
   - Type part of a name or message content
   - Threads should filter in real-time

6. **Test Read Receipts**:
   - Send a message from one user
   - Open the thread from the other user
   - The message should be marked as read
   - Unread count should decrease

## API Testing (Using curl or Postman)

### Create a Thread
```bash
curl -X POST http://localhost:5000/api/messages/threads \
  -H "Content-Type: application/json" \
  -d '{
    "trainer_id": 1,
    "client_id": 1,
    "subject": "Test Conversation",
    "initial_message": "Hello!",
    "sender_type": "trainer"
  }'
```

### Get Threads
```bash
curl "http://localhost:5000/api/messages/threads?user_type=trainer&user_id=1"
```

### Send a Message
```bash
curl -X POST http://localhost:5000/api/messages/threads/1/messages \
  -H "Content-Type: application/json" \
  -d '{
    "sender_type": "trainer",
    "sender_id": 1,
    "content": "This is a test message"
  }'
```

### Get Unread Count
```bash
curl "http://localhost:5000/api/messages/unread-count?user_type=trainer&user_id=1"
```

## Expected Behavior

### ✅ Success Indicators:
- Threads load in the sidebar
- Can create new threads
- Messages send and appear immediately
- Real-time updates work (messages appear in other windows)
- Unread badges update correctly
- Search filters threads
- Read receipts work
- Archive functionality works

### ⚠️ Common Issues:

1. **Socket.IO Connection Failed**:
   - Check that backend server is running
   - Verify CORS settings in `backend/app.py`
   - Check browser console for errors

2. **Messages Not Appearing**:
   - Check browser console for JavaScript errors
   - Verify API endpoints are accessible
   - Check network tab for failed requests

3. **Database Errors**:
   - Ensure database is running and accessible
   - Check `DATABASE_URL` environment variable
   - Run database migrations if needed

4. **Real-Time Not Working**:
   - Verify Socket.IO server is running
   - Check that Socket.IO client library is loaded
   - Check browser console for Socket.IO connection status

## Database Schema

The following tables are created automatically:
- `message_threads` - Conversation threads
- `messages` - Individual messages
- `message_attachments` - File attachments

## Next Steps

After testing M5.1, you can proceed to:
- **M5.2**: SMS Integration (Twilio)
- **M5.3**: Email Campaigns
- **M5.4**: Automated Reminders

## Notes

- The current implementation uses hardcoded user IDs (`currentUser = { type: 'trainer', id: 1 }`). In production, this should come from authentication/session.
- File attachments are supported but the UI for uploading files in messages is not yet implemented (can be added later).
- Message search is basic - can be enhanced with full-text search later.

